name: Build GDExtension (Windows)

on:
    workflow_call:

jobs:
    build:
        runs-on: windows-latest #blacksmith-4vcpu-windows-2025
        strategy:
            fail-fast: false
            matrix:
                include:
                    - target: template_debug
                      arch: x86_64
                    - target: template_release
                      arch: x86_64

        steps:
            - name: Checkout repository
              uses: actions/checkout@v6
              with:
                  submodules: recursive

            - name: Clone godot-cpp
              run: |
                  git clone --depth 1 --branch 4.5 https://github.com/godotengine/godot-cpp.git godot-cpp

            - name: Setup Python
              uses: actions/setup-python@v6.2.0
              with:
                  python-version: "3.11"

            - name: Install SCons
              run: |
                  pip install scons

            - name: Setup MSVC
              uses: ilammy/msvc-dev-cmd@v1.13.0
              with:
                  arch: x64

            - name: Install Vulkan SDK
              uses: humbletim/install-vulkan-sdk@v1.2
              with:
                  version: 1.4.309.0
                  cache: true

            - name: Debug Vulkan SDK
              shell: pwsh
              run: |
                  echo "VULKAN_SDK=$env:VULKAN_SDK"
                  echo "Checking Include directory..."
                  if (Test-Path "$env:VULKAN_SDK\Include\vulkan\vulkan_core.h") {
                    echo "vulkan_core.h found!"
                  } else {
                    echo "vulkan_core.h NOT found!"
                    Get-ChildItem "$env:VULKAN_SDK" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 20
                  }

            - name: Build GDExtension (w/ Vulkan)
              shell: pwsh
              run: |
                  echo "VULKAN_SDK=$env:VULKAN_SDK"
                  scons target=${{ matrix.target }} arch=${{ matrix.arch }} use_vulkan=yes

            - name: Upload artifact
              uses: actions/upload-artifact@v6
              with:
                  name: whisper-windows-${{ matrix.target }}-${{ matrix.arch }}
                  path: addon/bin/windows/
                  if-no-files-found: error
